<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LivabilityAI v4.2 - Ya≈üam Kalitesi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], heading: ['Poppins', 'sans-serif'] } } }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .map-container { height: 400px; width: 100%; border-radius: 1rem; }
        .loader { border: 4px solid rgba(255,255,255,0.1); border-left-color: #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .ai-text {
            background: linear-gradient(to right, #60a5fa, #c084fc, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <div class="fixed inset-0 z-[-1]">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-purple-900/30 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-900/30 rounded-full blur-[100px]"></div>
    </div>

    <header class="w-full py-6 px-8 flex justify-between items-center glass sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-city text-blue-400 text-2xl"></i>
            <span class="font-heading text-xl font-bold">Livability<span class="text-blue-400">AI</span></span>
        </div>
        <span class="text-xs font-mono text-slate-400 border border-slate-700 px-2 py-1 rounded">v4.2 Detaylƒ±</span>
    </header>

    <main class="flex-grow container mx-auto px-4 py-10 max-w-5xl">
        
        <div class="text-center mb-8 fade-in">
            <h1 class="font-heading text-4xl md:text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-200 via-white to-purple-200">
                Evinizin Ger√ßek Deƒüeri
            </h1>
            <p class="text-slate-400 text-sm md:text-base max-w-2xl mx-auto">
                Yapay zeka destekli detaylƒ± konum analizi
            </p>
        </div>

        <div class="max-w-2xl mx-auto mb-6 fade-in relative z-20">
            <div class="flex gap-2">
                <div class="relative flex-grow">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="location-search" placeholder="≈ûehir, il√ße veya mahalle arayƒ±n..." class="w-full bg-slate-800/80 border border-slate-600 text-white pl-12 pr-4 py-3 rounded-xl focus:outline-none focus:border-blue-500 transition" onkeypress="handleKeyPress(event)">
                </div>
                <button onclick="searchLocation()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-semibold transition"><i class="fa-solid fa-search"></i></button>
            </div>
        </div>

        <div class="glass p-2 rounded-2xl shadow-2xl mb-8 fade-in relative z-10">
            <div id="map" class="map-container"></div>
        </div>

        <div class="flex justify-center mb-16 fade-in">
            <button id="analyze-btn" onclick="analyzeLocation()" disabled class="px-8 py-3 bg-slate-800 text-slate-500 rounded-xl font-bold transition w-full md:w-auto cursor-not-allowed">
                <span>√ñnce Konum Se√ßin</span>
            </button>
        </div>

        <div id="loading-screen" class="hidden fixed inset-0 bg-slate-900/90 z-[60] flex flex-col items-center justify-center backdrop-blur-md">
            <div class="loader mb-6"></div>
            <h3 class="text-xl font-bold text-white mb-2">Analiz Ediliyor</h3>
            <p id="loading-text" class="text-slate-400 text-sm font-mono">Veriler toplanƒ±yor...</p>
        </div>

        <div id="results-section" class="hidden space-y-6 fade-in pb-20">
            
            <div class="glass rounded-3xl p-6 border border-blue-500/30">
                <div class="flex items-start gap-4">
                    <div class="p-3 bg-blue-500/10 rounded-xl text-blue-400 hidden md:block">
                        <i class="fa-solid fa-robot text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold uppercase tracking-wider mb-2 flex items-center gap-2">
                            <span class="ai-text">YAPAY ZEKA YORUMU</span>
                            <i class="fa-solid fa-wand-magic-sparkles text-purple-400 text-xs"></i>
                        </h3>
                        <p id="ai-comment" class="text-slate-200 leading-relaxed text-sm md:text-base">Yorum olu≈üturuluyor...</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass rounded-3xl p-6 flex flex-col items-center justify-center text-center">
                    <h3 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-4">GENEL SKOR</h3>
                    <div class="relative w-32 h-32 flex items-center justify-center">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#1e293b" stroke-width="8" />
                            <circle id="score-circle" cx="50" cy="50" r="45" fill="none" stroke="#3b82f6" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283" transform="rotate(-90 50 50)" class="transition-all duration-1000" />
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="main-score" class="text-4xl font-bold">0</span>
                        </div>
                    </div>
                    <div id="score-label" class="mt-4 text-lg font-bold text-blue-400">-</div>
                </div>

                <div class="col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="glass rounded-2xl p-5">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fa-solid fa-users-rays text-purple-400"></i>
                            <h4 class="font-semibold text-sm">Mahalle</h4>
                        </div>
                        <div id="vibe-tag" class="inline-block px-2 py-1 bg-purple-500/20 text-purple-300 text-xs rounded font-bold mb-2">...</div>
                        <p id="vibe-desc" class="text-xs text-slate-400 italic">...</p>
                    </div>

                    <div class="glass rounded-2xl p-5">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fa-solid fa-mountain text-emerald-400"></i>
                            <h4 class="font-semibold text-sm">Coƒürafya</h4>
                        </div>
                        <div class="space-y-1 text-xs">
                            <div class="flex justify-between"><span>Rakƒ±m:</span> <span id="geo-alt" class="font-mono text-emerald-300">0m</span></div>
                            <div class="flex justify-between"><span>Eƒüim:</span> <span id="geo-slope" class="font-mono text-emerald-300">%0</span></div>
                            <div class="flex justify-between"><span>Durum:</span> <span id="geo-walk" class="text-white">...</span></div>
                        </div>
                    </div>
                    
                    <div class="col-span-2 glass rounded-2xl p-5">
                         <div class="space-y-3">
                             <div>
                                 <div class="flex justify-between text-xs mb-1"><span>Sosyal & Ye≈üil</span><span id="score-green-val" class="font-bold">0</span></div>
                                 <div class="w-full bg-slate-700 rounded-full h-1.5"><div id="score-green-bar" class="bg-emerald-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                             </div>
                             <div>
                                 <div class="flex justify-between text-xs mb-1"><span>Yerle≈üim</span><span id="score-settle-val" class="font-bold">0</span></div>
                                 <div class="w-full bg-slate-700 rounded-full h-1.5"><div id="score-settle-bar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                             </div>
                             <div>
                                 <div class="flex justify-between text-xs mb-1"><span>Sessizlik</span><span id="score-noise-val" class="font-bold">0</span></div>
                                 <div class="w-full bg-slate-700 rounded-full h-1.5"><div id="score-noise-bar" class="bg-amber-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>

            <!-- YENI: DETAYLI ANALƒ∞Z -->
            <div id="detailed-analysis" class="hidden glass rounded-3xl p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-magnifying-glass-chart text-blue-400"></i>
                    Detaylƒ± Analiz
                </h3>
                <div id="details-content" class="space-y-4 text-sm"></div>
            </div>

            <div class="glass rounded-3xl p-6">
                <div class="flex items-center gap-3 mb-6 border-b border-white/10 pb-4">
                    <div class="p-2 bg-blue-500/20 rounded-lg text-blue-400"><i class="fa-solid fa-map-location-dot"></i></div>
                    <h3 class="text-lg font-bold">Yakƒ±ndaki √ñnemli Yerler</h3>
                </div>
                <div id="places-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[300px] overflow-y-auto custom-scroll pr-2">
                    <div class="text-slate-500 text-sm text-center col-span-2">Veri yok...</div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const BASE_API_URL = "https://yasam-skoru-api.onrender.com"; 

        const map = L.map('map').setView([39.933, 32.859], 6); 
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

        let selectedMarker = null, selectedLat = null, selectedLon = null;

        map.on('click', function(e) { updateMarker(e.latlng.lat, e.latlng.lng); });
        
        function updateMarker(lat, lng) {
            selectedLat = lat; selectedLon = lng;
            if (selectedMarker) map.removeLayer(selectedMarker);
            selectedMarker = L.marker([lat, lng]).addTo(map);
            const btn = document.getElementById('analyze-btn');
            btn.disabled = false;
            btn.className = "px-8 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-500 transition w-full md:w-auto";
            btn.innerHTML = `<span>Analiz Et</span> <i class="fa-solid fa-rocket ml-2"></i>`;
        }

        async function searchLocation() {
            const query = document.getElementById('location-search').value;
            if (!query) return;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const results = await response.json();
                if (results.length > 0) {
                    const lat = parseFloat(results[0].lat), lon = parseFloat(results[0].lon);
                    map.flyTo([lat, lon], 14);
                    updateMarker(lat, lon);
                } else alert("Konum bulunamadƒ±!");
            } catch (error) { alert("Arama hatasƒ±: " + error.message); }
        }
        
        function handleKeyPress(e) { if (e.key === 'Enter') searchLocation(); }

        async function analyzeLocation() {
            if (!selectedLat || !selectedLon) return;
            const loading = document.getElementById('loading-screen');
            const loadingText = document.getElementById('loading-text');
            loading.classList.remove('hidden');
            const messages = ["Uydu verileri taranƒ±yor...", "G√ºr√ºlt√º analizi...", "Sosyal tesisler...", "AI yorumluyor..."];
            let idx = 0;
            const interval = setInterval(() => { loadingText.innerText = messages[idx]; idx = (idx + 1) % messages.length; }, 1500);

            try {
                const response = await fetch(`${BASE_API_URL}/hesapla`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: selectedLat, lon: selectedLon })
                });
                if (!response.ok) throw new Error("API Hatasƒ±");
                const data = await response.json();
                updateUI(data);
                document.getElementById('results-section').classList.remove('hidden');
                setTimeout(() => document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' }), 100);
            } catch (error) { alert("Hata: " + error.message); } 
            finally { clearInterval(interval); loading.classList.add('hidden'); }
        }

        function updateUI(data) {
            const ozellik = data.ozellikler, skor = data.skor_ozeti, mekanlar = data.yakin_yerler || [];
            const detaylar = data.detayli_analiz || {};

            document.getElementById('ai-comment').innerText = data.ai_yorumu || "Yorum alƒ±namadƒ±.";

            const circle = document.getElementById('score-circle');
            const offset = 283 - (skor.genel_skor / 100) * 283;
            circle.style.strokeDashoffset = offset;
            let color = "#ef4444", label = "Zayƒ±f";
            if(skor.genel_skor > 50) { color = "#f59e0b"; label = "Orta"; }
            if(skor.genel_skor > 70) { color = "#3b82f6"; label = "ƒ∞yi"; }
            if(skor.genel_skor > 85) { color = "#10b981"; label = "M√ºkemmel"; }
            circle.style.stroke = color;
            document.getElementById('main-score').innerText = skor.genel_skor;
            document.getElementById('main-score').style.color = color;
            document.getElementById('score-label').innerText = label;
            document.getElementById('score-label').style.color = color;

            document.getElementById('vibe-tag').innerText = ozellik.mahalle_karakteri.etiket;
            document.getElementById('vibe-desc').innerText = ozellik.mahalle_karakteri.aciklama;
            document.getElementById('geo-alt').innerText = ozellik.cografya.rakim;
            document.getElementById('geo-slope').innerText = ozellik.cografya.egim_orani;
            document.getElementById('geo-walk').innerText = ozellik.cografya.yurunebilirlik;

            updateBar('score-green', skor.detaylar.yesil_sosyal);
            updateBar('score-settle', skor.detaylar.yerlesim);
            updateBar('score-noise', skor.detaylar.gurultu);

            // DETAYLI ANALƒ∞Z
            if (Object.keys(detaylar).length > 0) {
                const detailsDiv = document.getElementById('details-content');
                detailsDiv.innerHTML = '';
                
                if (detaylar.sosyal) {
                    let html = '<div class="bg-emerald-500/10 p-4 rounded-xl"><h4 class="font-bold mb-2 text-emerald-400">üéØ Sosyal Tesisler</h4><ul class="space-y-1 text-xs">';
                    for (const [key, val] of Object.entries(detaylar.sosyal)) {
                        html += `<li>‚Ä¢ <b>${key}</b>: ${val.closest} (${val.distance}m) - ${val.count} adet</li>`;
                    }
                    html += '</ul></div>';
                    detailsDiv.innerHTML += html;
                }
                
                if (detaylar.yerlesim) {
                    let html = '<div class="bg-blue-500/10 p-4 rounded-xl"><h4 class="font-bold mb-2 text-blue-400">üèòÔ∏è Yerle≈üim Kalitesi</h4><ul class="space-y-1 text-xs">';
                    for (const [key, val] of Object.entries(detaylar.yerlesim)) {
                        html += `<li>‚Ä¢ <b>${key}</b>: ${val.closest} (${val.distance}m) - Skor: ${val.score}/100</li>`;
                    }
                    html += '</ul></div>';
                    detailsDiv.innerHTML += html;
                }
                
                if (detaylar.gurultu) {
                    const html = `<div class="bg-amber-500/10 p-4 rounded-xl"><h4 class="font-bold mb-2 text-amber-400">üîä G√ºr√ºlt√º Analizi</h4><p class="text-xs">${detaylar.gurultu.reason}${detaylar.gurultu.closest ? ` - En yakƒ±n: ${detaylar.gurultu.closest}` : ''}</p></div>`;
                    detailsDiv.innerHTML += html;
                }
                
                document.getElementById('detailed-analysis').classList.remove('hidden');
            }

            const listContainer = document.getElementById('places-container');
            listContainer.innerHTML = ""; 
            if (mekanlar.length === 0) { 
                listContainer.innerHTML = '<div class="col-span-2 text-center text-slate-500 p-4">Veri yok</div>'; 
            } else {
                const getIcon = (cat) => {
                    if(cat.includes('market')) return 'fa-cart-shopping text-green-400';
                    if(cat.includes('okul')) return 'fa-graduation-cap text-blue-400';
                    if(cat.includes('saglik')) return 'fa-heart-pulse text-red-400';
                    if(cat.includes('ulasim')) return 'fa-bus text-yellow-400';
                    if(cat.includes('park')) return 'fa-tree text-emerald-400';
                    if(cat.includes('deniz')) return 'fa-water text-cyan-400';
                    return 'fa-location-dot text-slate-400';
                };
                mekanlar.forEach(m => {
                    listContainer.innerHTML += `
                        <div class="flex items-center justify-between bg-white/5 p-3 rounded-xl border border-white/5 hover:bg-white/10 transition">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center">
                                    <i class="fa-solid ${getIcon(m.kategori)} text-sm"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-sm">${m.isim}</div>
                                    <div class="text-xs text-slate-500">${m.kategori}</div>
                                </div>
                            </div>
                            <div class="font-mono text-sm text-blue-300">${m.mesafe}m</div>
                        </div>`;
                });
            }
        }

        function updateBar(prefix, val) {
            document.getElementById(`${prefix}-val`).innerText = val;
            document.getElementById(`${prefix}-bar`).style.width = `${val}%`;
        }
    </script>
</body>
</html>
